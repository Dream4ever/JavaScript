# 第七课 - 中间件及路由

今天光顾着听课了，很多内容没记下来。

## 玉飞玩箭头

你还玩得挺爽！

函数式编程其实并不复杂。以前的数学里面，函数就是 `y = f(x)`。写成 JS 代码，就是 `var y = function(x)`。是不是很像？其实就是一样的嘛。

函数式编程，本质上就是数学运算的一种方式。对于一个数学公式，给定一个输入，必定有一个输出与之对应。那么程序中的函数，如何保证给定一个输入必定有一个输出？此处略去一万字。

- 函数式编程：定义好流程，用户只需要往里面填数据即可。
- 结构式编程：需要用户照顾好整个流程。

箭头函数其实很简单的，可以理解为就是为了省略 `function` 这个关键字，但它的本质其实不止于此。现在先不深挖了，不然你就完蛋了，哈哈哈。

## app.use()

`app.use('/', page)` 这个代码，既然可以改写成下面的形式，那能不能进一步拓展，把很多个 `app.use()` 都放到一个里面？可以的。

```javascript
app.use('/', function(res, req, next) {
    console.log('1234');
    next();
}, page);
```

不管各个中间件用什么方式写，如果其中的一个中间件挂掉了，如果没有妥善的异常处理，那么整个程序就挂掉了！这样的中间件就是渣渣，千万不要用这样的中间件。

所有的代码都会出错，所以中间件一定要有一个异常处理机制。要么中间件自己给处理掉了，要么就调用 `next(err)` 交给 Express 处理，因为这些中间件都是为 Express 写的嘛！

## 来个好玩的中间件 - 封 IP

用 `express ip` 作为关键字在 GitHub 上搜索，还真有这么一个中间件。一天研究一个中间件，能够显著提高生产力哦。

## WebApp 教程第 20 节

服务端如何高效地构建页面？EJS 算是做了一些改进，但是还不够好，于是就有了 Express-Ejs-Layouts，这样还是治标不治本。于是就有了 Vue/React，它们站在更高的层次上来解决页面构建的问题。

## 路由的新玩法

一个 URL `www.baidu.com/x/y?id=123` 包含三部分：`www.baidu.com` 是域名，`/x/y` 是路径/路由，`?id=123` 则是参数。

Post 请求是一个比较安全的请求，所以可以把请求内容放到请求体（body）之中。

而不管路径、参数和 body 是什么，经过 Express 中间层处理之后，就会映射成对应的内容 => 路径被映射为 `req.params`，参数映射为 `req.query`，body 则映射为 `req.body`。这样就拿到了一个请求的所有数据，然后就可以为所欲为了。这就是中间件的魅力——把数据整理好了，我们就可以直接用了。

三大金刚：请求都封装在了 `req` 之中，响应都封装在了 `res` 之中，流程处理则都交给 `next()` 来做，这就是 Express 框架厉害的地方。

那么为什么 Express 能够把 `/posts/create` 解析到 `posts/:tag` 这个路由中呢？

## 题外话

微服务：将大服务独立成一个个的个体，互相关联起来。一个坏掉，不会影响其它服务，减轻了运营维护的压力。

函数服务：一个函数就是一个服务。以美图秀秀为例：为什么一个模板不能对应于一个函数服务呢？用户传入一张图片，应用一个模板，就执行一个函数，实现这个效果。
